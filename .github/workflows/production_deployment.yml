env:
  LOCATION_CODE: euw

name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      manualApproval:
        description: 'Manual approval (bypasses token validation - requires repo admin)'
        type: boolean
        default: false
      deploymentId:
        description: 'Deployment ID to promote to production'
        required: false
      artifactId:
        description: 'Artifact ID to deploy (format: web-dist-YYYYMMDD_HHMMSS)'
        required: false
      token:
        description: 'Encoded approval token (not required for manual approval)'
        required: false
      runID:
        description: 'Run ID from staging deployment'
        required: false
      useLatestArtifact:
        description: 'Use latest successful staging artifact (for manual approval)'
        type: boolean
        default: true
      includeDnsUpdate:
        description: 'Include DNS configuration update'
        type: boolean
        default: false

jobs:
  validate_approval:
    runs-on: ubuntu-latest
    outputs:
      validation_passed: ${{ steps.validation_check.outputs.passed }}
      artifact_id: ${{ steps.resolve_artifact.outputs.artifact_id }}
      run_id: ${{ steps.resolve_artifact.outputs.run_id }}
      deployment_id: ${{ steps.resolve_artifact.outputs.deployment_id }}
    steps:
      - name: Check Manual Approval Authorization
        id: check_manual
        if: github.event.inputs.manualApproval == 'true'
        run: |
          echo "ğŸ” Manual approval requested by: ${{ github.actor }}"
          echo "Manual approval mode - token validation bypassed"
          echo "is_manual=true" >> $GITHUB_OUTPUT

      - name: Validate Token (Automated Flow)
        id: token_validation
        if: github.event.inputs.manualApproval != 'true'
        run: |
          if [[ -z "${{ github.event.inputs.token }}" ]]; then
            echo "âŒ Token is required for automated approval"
            exit 1
          fi
          DECODED_TOKEN=$(echo "${{ github.event.inputs.token }}" | base64 -d)
          if [[ "$DECODED_TOKEN" != "${{ secrets.PROD_DEPLOYMENT_TOKEN }}" ]]; then
            echo "âŒ Invalid approval token"
            exit 1
          fi
          echo "âœ… Token validated successfully"

      - name: Find Latest Staging Artifact
        id: find_latest
        if: github.event.inputs.manualApproval == 'true' && github.event.inputs.useLatestArtifact == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ” Finding latest successful staging deployment..."

          # Get the latest successful staging workflow run
          LATEST_RUN=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/workflows/deploy.yml/runs?status=success&per_page=5" \
            --jq '.workflow_runs[0]')

          if [[ -z "$LATEST_RUN" || "$LATEST_RUN" == "null" ]]; then
            echo "âŒ No successful staging deployments found"
            exit 1
          fi

          RUN_ID=$(echo "$LATEST_RUN" | jq -r '.id')
          echo "Found staging run: $RUN_ID"

          # Get artifacts from that run
          ARTIFACTS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts" \
            --jq '.artifacts[] | select(.name | startswith("web-dist-"))')

          ARTIFACT_NAME=$(echo "$ARTIFACTS" | jq -r '.name' | head -1)

          if [[ -z "$ARTIFACT_NAME" || "$ARTIFACT_NAME" == "null" ]]; then
            echo "âŒ No web-dist artifact found in run $RUN_ID"
            exit 1
          fi

          echo "âœ… Found artifact: $ARTIFACT_NAME from run: $RUN_ID"
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Resolve Artifact Details
        id: resolve_artifact
        run: |
          # Determine artifact ID based on input method
          if [[ "${{ github.event.inputs.manualApproval }}" == "true" && "${{ github.event.inputs.useLatestArtifact }}" == "true" ]]; then
            ARTIFACT_ID="${{ steps.find_latest.outputs.artifact_name }}"
            RUN_ID="${{ steps.find_latest.outputs.run_id }}"
            DEPLOYMENT_ID="manual_${RUN_ID}_${{ github.run_id }}"
          else
            ARTIFACT_ID="${{ github.event.inputs.artifactId }}"
            RUN_ID="${{ github.event.inputs.runID }}"
            DEPLOYMENT_ID="${{ github.event.inputs.deploymentId }}"
          fi

          echo "artifact_id=$ARTIFACT_ID" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Artifact: $ARTIFACT_ID"
          echo "ğŸ”¢ Run ID: $RUN_ID"
          echo "ğŸ†” Deployment ID: $DEPLOYMENT_ID"

      - name: Validate Artifact Format
        id: validation_check
        run: |
          ARTIFACT_ID="${{ steps.resolve_artifact.outputs.artifact_id }}"

          if [[ -z "$ARTIFACT_ID" ]]; then
            echo "âŒ Artifact ID is required"
            exit 1
          fi

          if [[ ! "$ARTIFACT_ID" =~ ^web-dist-[0-9]{8}_[0-9]{6}$ ]]; then
            echo "âŒ Invalid artifact ID format: $ARTIFACT_ID"
            echo "Expected format: web-dist-YYYYMMDD_HHMMSS"
            exit 1
          fi

          echo "âœ… Artifact format validated: $ARTIFACT_ID"
          echo "passed=true" >> $GITHUB_OUTPUT

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # âœ… DEPLOY PRODUCTION RESOURCES
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy_resources_production:
    runs-on: ubuntu-latest
    needs: validate_approval
    if: needs.validate_approval.outputs.validation_passed == 'true'
    outputs:
      staticSiteUrl: ${{ steps.deploy_production_resources.outputs.staticSiteUrl }}
      teamsLogicAppUrl: ${{ steps.deploy_production_resources.outputs.teamsLogicAppUrl }}
      githubLogicAppUrl: ${{ steps.deploy_production_resources.outputs.githubLogicAppUrl }}
      deployment_id: ${{ needs.validate_approval.outputs.deployment_id }}
      artifact_id: ${{ needs.validate_approval.outputs.artifact_id }}
      run_id: ${{ needs.validate_approval.outputs.run_id }}
    steps:
      - name: Log Deployment Info
        run: |
          echo "ğŸš€ Starting production deployment"
          echo "ğŸ“¦ Artifact: ${{ needs.validate_approval.outputs.artifact_id }}"
          echo "ğŸ”¢ Source Run ID: ${{ needs.validate_approval.outputs.run_id }}"
          echo "ğŸ†” Deployment ID: ${{ needs.validate_approval.outputs.deployment_id }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ”§ Manual approval: ${{ github.event.inputs.manualApproval }}"

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: phoenixvc/PhoenixVC-Website
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Deploy Production Resources
        id: deploy_production_resources
        uses: ./.github/actions/deploy-azure-resources
        with:
          environment: production
          azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          location_code: ${{ env.LOCATION_CODE }}
          repository: phoenixvc/PhoenixVC-Website
          token: ${{ secrets.GITHUB_TOKEN }}
          skip_logic_apps: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # âœ… SWA DEPLOYMENT VIA SWA CLI
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  swa_deploy_production:
    runs-on: ubuntu-latest
    needs: deploy_resources_production
    timeout-minutes: 15
    environment:
      name: production
      url: ${{ steps.swa_deploy.outputs.deployment_url }}
    outputs:
      production_url: ${{ steps.swa_deploy.outputs.deployment_url }}
      deployment_id: ${{ steps.swa_deploy.outputs.deployment_id }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: phoenixvc/PhoenixVC-Website
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Use SWA Deploy Action for Production
        id: swa_deploy
        uses: ./.github/actions/swa-deploy
        with:
          artifact-name: ${{ needs.deploy_resources_production.outputs.artifact_id }}
          run-id: ${{ needs.deploy_resources_production.outputs.run_id }}
          app-name: prod-${{ env.LOCATION_CODE }}-swa-phoenixvc-website
          resource-group: prod-${{ env.LOCATION_CODE }}-rg-phoenixvc-website
          env: production
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          deployment_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PROD }}

      - name: Verify SWA Deployment
        run: |
          URL="${{ needs.deploy_resources_production.outputs.staticSiteUrl }}"

          if [[ -z "$URL" ]]; then
            echo "âŒ URL is empty. Check your deploy_resources_production outputs."
            exit 1
          fi

          MAX_RETRIES=10
          COUNT=0
          while [ $COUNT -lt $MAX_RETRIES ]; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
            if [ "$STATUS" == "200" ]; then
              echo "âœ… SWA deployment verified successfully at $URL!"
              exit 0
            fi
            echo "â³ Waiting for deployment at $URL... (Attempt $((COUNT + 1))/$MAX_RETRIES)"
            sleep 30
            COUNT=$((COUNT+1))
          done

          echo "âŒ SWA deployment verification failed at $URL after $MAX_RETRIES attempts"
          exit 1

      - name: Record Version
        run: |
          echo "DEPLOY_VERSION=$(date '+%Y%m%d')_${{ github.event.inputs.runId }}" >> $GITHUB_ENV

      - name: Create Version Tag
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'refs/tags/prod_${{ env.DEPLOY_VERSION }}',
              sha: context.sha
            })

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      #- name: Store Deployment Metadata
      #  run: |
      #    cat << EOF > deployment_metadata.json
      #    {
      #      "version": "${{ env.DEPLOY_VERSION }}",
      #      "deploymentId": "${{ github.event.inputs.deploymentId }}",
      #      "artifactId": "${{ github.event.inputs.artifactId }}",
      #      "runId": "${{ github.event.inputs.runId }}",
      #      "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
      #    }
      #    EOF
      #
      #    az storage blob upload \
      #      --account-name ${{ secrets.STORAGE_ACCOUNT_NAME }} \
      #     --container-name deployments \
      #     --name "prod_${{ env.DEPLOY_VERSION }}.json" \
      #     --file deployment_metadata.json
      #
      #- name: Create Job Summary
      #  run: |
      #    echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
      #    echo "* Static Site: ${{ steps.deploy_production_resources.outputs.staticSiteUrl }}" >> $GITHUB_STEP_SUMMARY
      #    echo "* Teams Logic App: ${{ needs.deploy_resources_production.outputs.teamsLogicAppUrl }}" >> $GITHUB_STEP_SUMMARY
      #   echo "* GitHub Logic App: ${{ needs.deploy_resources_production.outputs.githubLogicAppUrl }}" >> $GITHUB_STEP_SUMMARY
      #
  trigger_dns_update:
    needs: swa_deploy_production
    if: needs.swa_deploy_production.result == 'success' && github.event.inputs.includeDnsUpdate == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger DNS Configuration
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/configure_dns.yml/dispatches \
            -d '{"ref": "refs/heads/main", "inputs": {"ENVIRONMENT": "prod"}}'

  deploy_docs:
    needs: swa_deploy_production
    if: needs.swa_deploy_production.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      docs_url: ${{ steps.deploy_docs_swa.outputs.static_web_app_url }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: phoenixvc/PhoenixVC-Website
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'

      - name: Install MkDocs
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material mkdocs-minify-plugin

      - name: Build Docs
        run: |
          mkdocs build -f docs/mkdocs.yml -d docs/site

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Docs to Azure Static Web App
        id: deploy_docs_swa
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.DOCS_DEPLOYMENT_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "docs/site"
          skip_app_build: true
          skip_api_build: true

      - name: Configure docs.phoenixvc.tech Custom Domain
        run: |
          RESOURCE_GROUP="prod-${{ env.LOCATION_CODE }}-rg-phoenixvc-website"
          DOCS_SWA_NAME="prod-${{ env.LOCATION_CODE }}-swa-phoenixvc-docs"
          DOMAIN="docs.phoenixvc.tech"

          echo "Configuring custom domain $DOMAIN for docs..."

          # Check if custom domain already exists
          DOMAIN_STATUS=$(az staticwebapp hostname show \
            --resource-group "$RESOURCE_GROUP" \
            --name "$DOCS_SWA_NAME" \
            --hostname "$DOMAIN" \
            --query "status" -o tsv 2>/dev/null || echo "NotFound")

          if [[ "$DOMAIN_STATUS" == "NotFound" ]]; then
            echo "Adding custom domain: $DOMAIN"
            az staticwebapp hostname set \
              --resource-group "$RESOURCE_GROUP" \
              --name "$DOCS_SWA_NAME" \
              --hostname "$DOMAIN" || echo "Domain setup may require manual DNS configuration"
          else
            echo "âœ… Custom domain $DOMAIN already configured (status: $DOMAIN_STATUS)"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # âœ… Configure Custom Domain and DNS
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  configure_custom_domain_dns:
    runs-on: ubuntu-latest
    needs: swa_deploy_production
    environment:
      name: production
    steps:
      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure Custom Domain & DNS
        shell: bash
        run: |
          RESOURCE_GROUP="prod-${{ env.LOCATION_CODE }}-rg-phoenixvc-website"
          STATIC_WEB_APP_NAME="prod-${{ env.LOCATION_CODE }}-swa-phoenixvc-website"
          DOMAIN="phoenixvc.tech"

          echo "Checking domain status for $DOMAIN..."

          DOMAIN_STATUS=$(az staticwebapp hostname show \
            --resource-group "$RESOURCE_GROUP" \
            --name "$STATIC_WEB_APP_NAME" \
            --hostname "$DOMAIN" \
            --query "status" -o tsv)

          echo "Domain status: $DOMAIN_STATUS"

          if [[ "$DOMAIN_STATUS" != "Ready" ]]; then
            echo "Linking custom domain: $DOMAIN"

            az staticwebapp hostname set \
              --resource-group "$RESOURCE_GROUP" \
              --name "$STATIC_WEB_APP_NAME" \
              --hostname "$DOMAIN" \
              --validation-method dns-txt-token

            echo "Fetching validation token..."
            sleep 30  # Wait briefly for token availability

            VALIDATION_TOKEN=$(az staticwebapp hostname show \
              --resource-group "$RESOURCE_GROUP" \
              --name "$STATIC_WEB_APP_NAME" \
              --hostname "$DOMAIN" \
              --query "validationToken" -o tsv)

            if [[ -z "$VALIDATION_TOKEN" ]]; then
              echo "âŒ Validation token retrieval failed."
              exit 1
            fi

            echo "Adding TXT record for domain validation"
            az network dns record-set txt add-record \
              --resource-group "$RESOURCE_GROUP" \
              --zone-name "$DOMAIN" \
              --record-set-name "asuid" \
              --value "$VALIDATION_TOKEN"

            echo "âœ… TXT record created successfully."
          else
            echo "âœ… Domain already verified. Skipping TXT validation."
          fi

          echo "Adding or updating CNAME record..."

          DEFAULT_HOSTNAME=$(az staticwebapp show \
            --resource-group "$RESOURCE_GROUP" \
            --name "$STATIC_WEB_APP_NAME" \
            --query "defaultHostname" -o tsv)

          az network dns record-set cname set-record \
            --resource-group "$RESOURCE_GROUP" \
            --zone-name "$DOMAIN" \
            --record-set-name "@" \
            --cname "$DEFAULT_HOSTNAME"

          echo "âœ… DNS configuration completed successfully."

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # âœ… Notification Job
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify_deployment:
    needs: [swa_deploy_production, trigger_dns_update, deploy_docs, configure_custom_domain_dns]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: phoenixvc/PhoenixVC-Website
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Notify Teams
        uses: ./.github/actions/teams-notification
        with:
          webhook_url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          title: ${{ needs.swa_deploy_production.result == 'success' && 'Production Deployment Complete' || 'Production Deployment Failed' }}
          message: ${{ needs.swa_deploy_production.result == 'success' && 'The deployment to PRODUCTION has completed successfully.' || 'The deployment to PRODUCTION has failed. Manual intervention required.' }}
          environment: "production"
          deployment_url: ${{ needs.swa_deploy_production.outputs.production_url }}
          logic_app_url: ${{ needs.deploy_resources_production.outputs.teamsLogicAppUrl }}
          github_logic_app_url: ${{ needs.deploy_resources_production.outputs.githubLogicAppUrl }}
          branch: ${{ github.ref }}
          location_code: ${{ env.LOCATION_CODE }}
          resource_group: prod-${{ env.LOCATION_CODE }}-rg-phoenixvc-website
          color: ${{ needs.swa_deploy_production.result == 'success' && '00A300' || 'FF0000' }}
          deployment_id: ${{ needs.deploy_resources_production.outputs.deployment_id }}
          artifact_id: ${{ needs.deploy_resources_production.outputs.artifact_id }}
          run_id: ${{ needs.deploy_resources_production.outputs.run_id }}
