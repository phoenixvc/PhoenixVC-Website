name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      deploymentId:
        description: 'Deployment ID to promote to production'
        required: true
      artifactId:
        description: 'Artifact ID to deploy to production'
        required: true
      token:
        description: 'Encoded approval token'
        required: true
      runID:
        description: 'Run ID'
        required: true
      includeDnsUpdate:
        description: 'Include DNS configuration update'
        type: boolean
        default: false

jobs:
  validate_approval:
    runs-on: ubuntu-latest
    outputs:
      validation_passed: ${{ steps.validation_check.outputs.passed }}
    steps:
      - name: Validate Token
        id: token_validation
        run: |
          DECODED_TOKEN=$(echo "${{ github.event.inputs.token }}" | base64 -d)
          if [[ "$DECODED_TOKEN" != "${{ secrets.PROD_DEPLOYMENT_TOKEN }}" ]]; then
            echo "Invalid approval token"
            exit 1
          fi

      - name: Check Deployment and Artifact
        id: validation_check
        run: |
          if [[ ! "${{ github.event.inputs.artifactId }}" =~ ^web-dist-[0-9]{8}_[0-9]{6}$ ]]; then
            echo "Invalid artifact ID format"
            exit 1
          fi
          echo "passed=true" >> $GITHUB_OUTPUT

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # âœ… DEPLOY PRODUCTION RESOURCES
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy_resources_production:
    runs-on: ubuntu-latest
    needs: validate_approval
    if: needs.validate_approval.outputs.validation_passed == 'true'
    outputs:
      staticSiteUrl: ${{ steps.deploy_production_resources.outputs.staticSiteUrl }}
      teamsLogicAppUrl: ${{ steps.deploy_production_resources.outputs.teamsLogicAppUrl }}
      githubLogicAppUrl: ${{ steps.deploy_production_resources.outputs.githubLogicAppUrl }}
      encoded_token: ${{ steps.encode_token.outputs.encoded_token }}
      deployment_id: ${{ steps.get_deployment_info.outputs.deployment_id }}
      artifact_id: ${{ steps.get_deployment_info.outputs.artifact_id }}
      run_id: ${{ github.run_id }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: JustAGhosT/PhoenixVC-Modernized
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Deploy Production Resources
        id: deploy_production_resources
        uses: ./.github/actions/deploy-azure-resources
        with:
          environment: production
          azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          location_code: ${{ env.LOCATION_CODE }}
          repository: JustAGhosT/PhoenixVC-Modernized
          token: ${{ secrets.PROD_DEPLOYMENT_TOKEN }}

      - name: Get Deployment Information
        id: get_deployment_info
        run: |
          DEPLOYMENT_ID="${{ github.run_id }}_${{ github.sha }}"
          ARTIFACT_ID="phoenixvc_$(date +%Y%m%d)_${{ github.sha }}_${{ github.run_number }}"
          echo "deployment_id=${DEPLOYMENT_ID}" >> $GITHUB_OUTPUT
          echo "artifact_id=${ARTIFACT_ID}" >> $GITHUB_OUTPUT

      - name: Encode GitHub Token
        id: encode_token
        run: |
          ENCODED_TOKEN=$(echo -n "${{ secrets.GITHUB_TOKEN }}" | base64)
          echo "encoded_token=${ENCODED_TOKEN}" >> $GITHUB_OUTPUT

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # âœ… DEPLOY TO PRODUCTION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy_to_production:
    needs: deploy_resources_production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.swa_deploy.outputs.deployment_url }}
    timeout-minutes: 30
    outputs:
      staticSiteUrl: ${{ steps.swa_deploy.outputs.deployment_url }}
      teamsLogicAppUrl: ${{ steps.deploy_production_resources.outputs.teamsLogicAppUrl }}
      githubLogicAppUrl: ${{ steps.deploy_production_resources.outputs.githubLogicAppUrl }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: JustAGhosT/PhoenixVC-Modernized
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Debug Available Artifacts
        run: |
          echo "ðŸ” Listing artifacts for run ID: ${{ github.event.inputs.runID }}"
          gh api repos/JustAGhosT/PhoenixVC-Modernized/actions/runs/${{ github.event.inputs.runID }}/artifacts --jq ".artifacts[].name"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Artifact via GitHub CLI
        run: |
          echo "â¬‡ï¸ Downloading artifact: ${{ github.event.inputs.artifactId }}"
          gh run download ${{ github.event.inputs.runID }} \
            --repo JustAGhosT/PhoenixVC-Modernized \
            --name ${{ github.event.inputs.artifactId }} \
            --dir apps/web/dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Downloaded Artifact
        run: |
          echo "ðŸ” Checking downloaded files..."
          ls -lh apps/web/dist

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # âœ… PRODUCTION SITE DEPLOYMENT VIA SWA CLI
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  swa_deploy_production:
    runs-on: ubuntu-latest
    needs: [deploy_to_production]
    timeout-minutes: 15
    environment:
      name: production
      url: ${{ steps.swa_deploy.outputs.deployment_url }}
    outputs:
        production_url: ${{ steps.swa_deploy.outputs.deployment_url }}
        deployment_id: ${{ steps.swa_deploy.outputs.deployment_id }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: JustAGhosT/PhoenixVC-Modernized
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Use SWA Deploy Action for Production
        id: swa_deploy
        uses: ./.github/actions/swa-deploy
        with:
          artifact-name: web-dist-${{ needs.deploy_resources_production.outputs.artifact_id }}
          app-name: prod-${{ env.LOCATION_CODE }}-swa-phoenixvc-website
          resource-group: prod-${{ env.LOCATION_CODE }}-rg-phoenixvc-website
          env: production
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          deployment_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PROD }}

      - name: Verify SWA Deployment
        run: |
          MAX_RETRIES=10
          COUNT=0
          while [ $COUNT -lt $MAX_RETRIES ]; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.deploy_production.outputs.staticSiteUrl }}")
            if [ "$STATUS" == "200" ]; then
              echo "âœ… SWA deployment verified successfully!"
              exit 0
            fi
            echo "Waiting for deployment to be available... (Attempt $COUNT/$MAX_RETRIES)"
            sleep 30
            COUNT=$((COUNT+1))
          done
          echo "âŒ SWA deployment verification failed after $MAX_RETRIES attempts"
          exit 1

      - name: Record Version
        run: |
          echo "DEPLOY_VERSION=$(date '+%Y%m%d')_${{ github.event.inputs.runId }}" >> $GITHUB_ENV

      - name: Create Version Tag
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'refs/tags/prod_${{ env.DEPLOY_VERSION }}',
              sha: context.sha
            })

      - name: Azure CLI Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Store Deployment Metadata
        run: |
          cat << EOF > deployment_metadata.json
          {
            "version": "${{ env.DEPLOY_VERSION }}",
            "deploymentId": "${{ github.event.inputs.deploymentId }}",
            "artifactId": "${{ github.event.inputs.artifactId }}",
            "runId": "${{ github.event.inputs.runId }}",
            "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          }
          EOF

          az storage blob upload \
            --account-name ${{ secrets.STORAGE_ACCOUNT_NAME }} \
            --container-name deployments \
            --name "prod_${{ env.DEPLOY_VERSION }}.json" \
            --file deployment_metadata.json

      - name: Create Job Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "* Static Site: ${{ steps.deploy_production.outputs.staticSiteUrl }}" >> $GITHUB_STEP_SUMMARY
          echo "* Teams Logic App: ${{ steps.deploy_production.outputs.teamsLogicAppUrl }}" >> $GITHUB_STEP_SUMMARY
          echo "* GitHub Logic App: ${{ steps.deploy_production.outputs.githubLogicAppUrl }}" >> $GITHUB_STEP_SUMMARY

  trigger_dns_update:
    needs: deploy_to_production
    if: needs.deploy_to_production.result == 'success' && github.event.inputs.includeDnsUpdate == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger DNS Configuration
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/configure_dns.yml/dispatches \
            -d '{"ref": "refs/heads/main", "inputs": {"ENVIRONMENT": "prod"}}'

  deploy_docs:
    needs: deploy_to_production
    if: needs.deploy_to_production.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: JustAGhosT/PhoenixVC-Modernized
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'

      - name: Install MkDocs
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material

      - name: Build and Deploy Docs
        run: |
          mkdocs build -f docs/mkdocs.yml
          mkdocs gh-deploy --force

  notify_deployment:
    needs: [deploy_to_production, trigger_dns_update, deploy_docs]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: JustAGhosT/PhoenixVC-Modernized
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Notify Teams
        uses: ./.github/actions/teams-notification
        with:
          webhook_url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          title: ${{ needs.deploy_to_production.result == 'success' && 'Production Deployment Complete' || 'Production Deployment Failed' }}
          message: ${{ needs.deploy_to_production.result == 'success' && 'The deployment to PRODUCTION has completed successfully.' || 'The deployment to PRODUCTION has failed. Manual intervention required.' }}
          environment: "production"
          deployment_url: ${{ needs.deploy_to_production.outputs.staticSiteUrl }}
          logic_app_url: ${{ needs.deploy_to_production.outputs.teamsLogicAppUrl }}
          github_logic_app_url: ${{ needs.deploy_to_production.outputs.githubLogicAppUrl }}
          branch: ${{ github.ref }}
          location_code: ${{ env.LOCATION_CODE }}
          resource_group: prod-${{ env.LOCATION_CODE }}-rg-phoenixvc-website
          color: ${{ needs.deploy_to_production.result == 'success' && '00A300' || 'FF0000' }}
          deployment_id: ${{ github.event.inputs.deploymentId }}
          artifact_id: ${{ github.event.inputs.artifactId }}
          run_id: ${{ github.event.inputs.runId }}
