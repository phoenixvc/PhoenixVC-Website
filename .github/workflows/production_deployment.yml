env:
  LOCATION_CODE: euw

name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      deploymentId:
        description: 'Deployment ID to promote to production'
        required: true
      artifactId:
        description: 'Artifact ID to deploy to production'
        required: true
      token:
        description: 'Encoded approval token'
        required: true
      runID:
        description: 'Run ID'
        required: true
      includeDnsUpdate:
        description: 'Include DNS configuration update'
        type: boolean
        default: false

jobs:
  validate_approval:
    runs-on: ubuntu-latest
    outputs:
      validation_passed: ${{ steps.validation_check.outputs.passed }}
    steps:
      - name: Validate Token
        id: token_validation
        run: |
          DECODED_TOKEN=$(echo "${{ github.event.inputs.token }}" | base64 -d)
          if [[ "$DECODED_TOKEN" != "${{ secrets.PROD_DEPLOYMENT_TOKEN }}" ]]; then
            echo "Invalid approval token"
            exit 1
          fi

      - name: Check Deployment and Artifact
        id: validation_check
        run: |
          if [[ ! "${{ github.event.inputs.artifactId }}" =~ ^web-dist-[0-9]{8}_[0-9]{6}$ ]]; then
            echo "Invalid artifact ID format"
            exit 1
          fi
          echo "passed=true" >> $GITHUB_OUTPUT

  # ───────────────────────────────────────────────
  # ✅ DEPLOY PRODUCTION RESOURCES
  # ───────────────────────────────────────────────
  deploy_resources_production:
    runs-on: ubuntu-latest
    needs: validate_approval
    if: needs.validate_approval.outputs.validation_passed == 'true'
    outputs:
      staticSiteUrl: ${{ steps.deploy_production_resources.outputs.staticSiteUrl }}
      teamsLogicAppUrl: ${{ steps.deploy_production_resources.outputs.teamsLogicAppUrl }}
      githubLogicAppUrl: ${{ steps.deploy_production_resources.outputs.githubLogicAppUrl }}
      encoded_token: ${{ steps.encode_token.outputs.encoded_token }}
      deployment_id: ${{ steps.get_deployment_info.outputs.deployment_id }}
      artifact_id: ${{ steps.get_deployment_info.outputs.artifact_id }}
      run_id: ${{ github.run_id }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: JustAGhosT/PhoenixVC-Modernized
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Deploy Production Resources
        id: deploy_production_resources
        uses: ./.github/actions/deploy-azure-resources
        with:
          environment: production
          azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          location_code: ${{ env.LOCATION_CODE }}
          repository: JustAGhosT/PhoenixVC-Modernized
          token: ${{ secrets.GITHUB_TOKEN }}
          skip_logic_apps: true

      - name: Get Deployment Information
        id: get_deployment_info
        run: |
          echo "deployment_id=${{ github.event.inputs.deploymentId }}" >> $GITHUB_OUTPUT
          echo "artifact_id=${{ github.event.inputs.artifactId }}" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.event.inputs.runID }}" >> $GITHUB_OUTPUT
          echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Encode GitHub Token
        id: encode_token
        run: |
          ENCODED_TOKEN=$(echo -n "${{ secrets.GITHUB_TOKEN }}" | base64)
          echo "encoded_token=${ENCODED_TOKEN}" >> $GITHUB_OUTPUT

  # ───────────────────────────────────────────────
  # ✅ SWA DEPLOYMENT VIA SWA CLI
  # ───────────────────────────────────────────────
  swa_deploy_production:
    runs-on: ubuntu-latest
    needs: deploy_resources_production
    timeout-minutes: 15
    environment:
      name: production
      url: ${{ steps.swa_deploy.outputs.deployment_url }}
    outputs:
      production_url: ${{ steps.swa_deploy.outputs.deployment_url }}
      deployment_id: ${{ steps.swa_deploy.outputs.deployment_id }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: JustAGhosT/PhoenixVC-Modernized
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Use SWA Deploy Action for Production
        id: swa_deploy
        uses: ./.github/actions/swa-deploy
        with:
          artifact-name: ${{ needs.deploy_resources_production.outputs.artifact_id }}
          run-id: ${{ github.event.inputs.runID }}
          app-name: prod-${{ env.LOCATION_CODE }}-swa-phoenixvc-website
          resource-group: prod-${{ env.LOCATION_CODE }}-rg-phoenixvc-website
          env: production
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          deployment_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PROD }}

      - name: Verify SWA Deployment
        run: |
          URL="${{ needs.deploy_resources_production.outputs.staticSiteUrl }}"
          
          if [[ -z "$URL" ]]; then
            echo "❌ URL is empty. Check your deploy_resources_production outputs."
            exit 1
          fi
          
          MAX_RETRIES=10
          COUNT=0
          while [ $COUNT -lt $MAX_RETRIES ]; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
            if [ "$STATUS" == "200" ]; then
              echo "✅ SWA deployment verified successfully at $URL!"
              exit 0
            fi
            echo "⏳ Waiting for deployment at $URL... (Attempt $((COUNT + 1))/$MAX_RETRIES)"
            sleep 30
            COUNT=$((COUNT+1))
          done
          
          echo "❌ SWA deployment verification failed at $URL after $MAX_RETRIES attempts"
          exit 1

      - name: Record Version
        run: |
          echo "DEPLOY_VERSION=$(date '+%Y%m%d')_${{ github.event.inputs.runId }}" >> $GITHUB_ENV

      - name: Create Version Tag
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'refs/tags/prod_${{ env.DEPLOY_VERSION }}',
              sha: context.sha
            })

      - name: Azure CLI Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      #- name: Store Deployment Metadata
      #  run: |
      #    cat << EOF > deployment_metadata.json
      #    {
      #      "version": "${{ env.DEPLOY_VERSION }}",
      #      "deploymentId": "${{ github.event.inputs.deploymentId }}",
      #      "artifactId": "${{ github.event.inputs.artifactId }}",
      #      "runId": "${{ github.event.inputs.runId }}",
      #      "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
      #    }
      #    EOF
      #
      #    az storage blob upload \
      #      --account-name ${{ secrets.STORAGE_ACCOUNT_NAME }} \
      #     --container-name deployments \
      #     --name "prod_${{ env.DEPLOY_VERSION }}.json" \
      #     --file deployment_metadata.json
      #
      #- name: Create Job Summary
      #  run: |
      #    echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
      #    echo "* Static Site: ${{ steps.deploy_production_resources.outputs.staticSiteUrl }}" >> $GITHUB_STEP_SUMMARY
      #    echo "* Teams Logic App: ${{ needs.deploy_resources_production.outputs.teamsLogicAppUrl }}" >> $GITHUB_STEP_SUMMARY
      #   echo "* GitHub Logic App: ${{ needs.deploy_resources_production.outputs.githubLogicAppUrl }}" >> $GITHUB_STEP_SUMMARY
      #
  trigger_dns_update:
    needs: swa_deploy_production
    if: needs.swa_deploy_production.result == 'success' && github.event.inputs.includeDnsUpdate == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger DNS Configuration
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/configure_dns.yml/dispatches \
            -d '{"ref": "refs/heads/main", "inputs": {"ENVIRONMENT": "prod"}}'

  configure_custom_domain:
    runs-on: ubuntu-latest
    needs: swa_deploy_production
    environment:
      name: production
    steps:
      - name: Azure CLI Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
  
      - name: Configure Custom Domain on Azure Static Web App
        shell: bash
        run: |
          DOMAIN="phoenixvc.tech"
          SUBDOMAIN=""  # Set this if you have a subdomain, leave blank otherwise
  
          if [[ -z "$SUBDOMAIN" ]]; then
            FULL_DOMAIN="$DOMAIN"
            RECORD_SET_NAME="asuid"
          else
            FULL_DOMAIN="$SUBDOMAIN.$DOMAIN"
            RECORD_SET_NAME="asuid.$SUBDOMAIN"
          fi
  
          echo "Configuring domain '$FULL_DOMAIN' on Azure Static Web App..."
  
          # Link custom domain to Static Web App and retrieve validation token
          VALIDATION_TOKEN=$(az staticwebapp hostname set \
            --resource-group "prod-${{ env.LOCATION_CODE }}-rg-phoenixvc-website" \
            --name "prod-${{ env.LOCATION_CODE }}-swa-phoenixvc-website" \
            --hostname "$FULL_DOMAIN" \
            --validation-method dns-txt \
            --query validationToken \
            -o tsv)
  
          echo "✅ Domain '$FULL_DOMAIN' configuration initiated. Validation Token: $VALIDATION_TOKEN"
  
          echo "Creating DNS record in Azure DNS zone '$DOMAIN'..."
  
          # Create TXT record for domain validation in Azure DNS
          az network dns record-set txt add-record \
            --resource-group "prod-${{ env.LOCATION_CODE }}-rg-phoenixvc-website" \
            --zone-name "$DOMAIN" \
            --record-set-name "$RECORD_SET_NAME" \
            --value "$VALIDATION_TOKEN"
  
          echo "✅ DNS record created successfully for domain validation."

  deploy_docs:
    needs: swa_deploy_production
    if: needs.swa_deploy_production.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: JustAGhosT/PhoenixVC-Modernized
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'

      - name: Install MkDocs
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material

      - name: Build and Deploy Docs
        run: |
          mkdocs build -f docs/mkdocs.yml
          mkdocs gh-deploy --force

   # ───────────────────────────────────────────────
  # ✅ Configure Custom Domain and DNS
  # ───────────────────────────────────────────────
  configure_custom_domain_dns:
    runs-on: ubuntu-latest
    needs: swa_deploy_production
    environment:
      name: production
    steps:
      - name: Azure CLI Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure Custom Domain & DNS
        shell: bash
        run: |
          RESOURCE_GROUP="prod-${{ env.LOCATION_CODE }}-rg-phoenixvc-website"
          STATIC_WEB_APP_NAME="prod-${{ env.LOCATION_CODE }}-swa-phoenixvc-website"
          DOMAIN="phoenixvc.tech"

          echo "Linking custom domain: $DOMAIN"

          # Set Custom Domain
          az staticwebapp hostname set \
            --resource-group "$RESOURCE_GROUP" \
            --name "$STATIC_WEB_APP_NAME" \
            --hostname "$DOMAIN" \
            --validation-method dns-txt

          echo "Fetching validation token for DNS"

          # Fetch Validation Token
          VALIDATION_TOKEN=$(az staticwebapp hostname show \
            --resource-group "$RESOURCE_GROUP" \
            --name "$STATIC_WEB_APP_NAME" \
            --hostname "$DOMAIN" \
            --query "validationToken" -o tsv)

          echo "Validation token retrieved: $VALIDATION_TOKEN"

          echo "Adding TXT record for domain validation"

          # Add TXT Record for validation
          az network dns record-set txt add-record \
            --resource-group "$RESOURCE_GROUP" \
            --zone-name "$DOMAIN" \
            --record-set-name "asuid" \
            --value "$VALIDATION_TOKEN"

          echo "Adding CNAME record to Azure Static Web App"

          # Add CNAME Record to point root domain to SWA
          DEFAULT_HOSTNAME=$(az staticwebapp show \
            --resource-group "$RESOURCE_GROUP" \
            --name "$STATIC_WEB_APP_NAME" \
            --query "defaultHostname" -o tsv)

          az network dns record-set cname set-record \
            --resource-group "$RESOURCE_GROUP" \
            --zone-name "$DOMAIN" \
            --record-set-name "@" \
            --cname "$DEFAULT_HOSTNAME"

          echo "✅ DNS configuration completed successfully."

  # ───────────────────────────────────────────────
  # ✅ Notification Job
  # ───────────────────────────────────────────────
  notify_deployment:
    needs: [swa_deploy_production, trigger_dns_update, deploy_docs, configure_custom_domain_dns]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: JustAGhosT/PhoenixVC-Modernized
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Notify Teams
        uses: ./.github/actions/teams-notification
        with:
          webhook_url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          title: ${{ needs.swa_deploy_production.result == 'success' && 'Production Deployment Complete' || 'Production Deployment Failed' }}
          message: ${{ needs.swa_deploy_production.result == 'success' && 'The deployment to PRODUCTION has completed successfully.' || 'The deployment to PRODUCTION has failed. Manual intervention required.' }}
          environment: "production"
          deployment_url: ${{ needs.swa_deploy_production.outputs.production_url }}
          logic_app_url: ${{ needs.deploy_resources_production.outputs.teamsLogicAppUrl }}
          github_logic_app_url: ${{ needs.deploy_resources_production.outputs.githubLogicAppUrl }}
          branch: ${{ github.ref }}
          location_code: ${{ env.LOCATION_CODE }}
          resource_group: prod-${{ env.LOCATION_CODE }}-rg-phoenixvc-website
          color: ${{ needs.swa_deploy_production.result == 'success' && '00A300' || 'FF0000' }}
          deployment_id: ${{ github.event.inputs.deploymentId }}
          artifact_id: ${{ github.event.inputs.artifactId }}
          run_id: ${{ github.event.inputs.runId }}

