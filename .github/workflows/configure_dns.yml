name: Phoenix VC - Configure DNS

on:
  workflow_dispatch:
    inputs:
      ENVIRONMENT:
        description: "Environment to configure DNS for (staging/prod)"
        required: true
        default: "prod"

env:
  LOCATION_CODE: 'euw'

jobs:
  configure-dns:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: refs/heads/main
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Use my Composite Azure Deployment
        uses: ./.github/actions/setup-azure-deployment
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          azure_subscription_id: ${{ env.AZURE_SUBSCRIPTION_ID }}
          azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
          repository: ${{ github.repository }}
          ref: ${{ github.ref }}

      - name: Extract AZURE_SUBSCRIPTION_ID from AZURE_CREDENTIALS
        id: extract-subscription
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          echo "Extracting subscriptionId from AZURE_CREDENTIALS..."
          export AZURE_SUBSCRIPTION_ID=$(echo "$AZURE_CREDENTIALS" | jq -r '.subscriptionId')
          echo "AZURE_SUBSCRIPTION_ID=$AZURE_SUBSCRIPTION_ID" >> $GITHUB_ENV

      - name: Verify Required Parameters
        env:
          AZURE_SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}
          SWA_NAME: ${{ secrets.SWA_NAME }}
          RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
        run: |
          echo "Verifying required environment variables..."
          : "${AZURE_SUBSCRIPTION_ID:?AZURE_SUBSCRIPTION_ID is not set}"
          : "${SWA_NAME:?SWA_NAME is not set}"
          : "${RESOURCE_GROUP:?RESOURCE_GROUP is not set}"
          echo "All required environment variables are set."

      - name: Verify configure-dns.sh Exists
        run: |
          ls -la ./scripts
          if [ ! -f ./scripts/deployment/configure-dns.sh ]; then
            echo "⚠️ configure-dns.sh is missing!"
            exit 1
          fi

      - name: Ensure configure-dns.sh is executable
        run: chmod +x ./scripts/deployment/configure-dns.sh

      - name: Run DNS Configuration Verify
        run: ./scripts/deployment/configure-dns.sh --verify --ENVIRONMENT ${{ github.event.inputs.ENVIRONMENT }}

      - name: Configure DNS
        run: ./scripts/deployment/configure-dns.sh --ENVIRONMENT ${{ github.event.inputs.ENVIRONMENT }}
