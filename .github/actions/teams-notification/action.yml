runs:
  using: "composite"
  steps:
    - name: Checkout Repository for Template
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Read and Substitute Template
      shell: bash
      id: build_payload
      run: |
        # Read the JSON template file from the repository root
        TEMPLATE=$(cat "$(pwd)/.github/actions/teams-notification/teams-template-schema.json")
        # Replace placeholders (the template should use placeholders like {{title}}, etc.) with the input values
        PAYLOAD=$(echo "$TEMPLATE" | sed \
          -e "s/{{title}}/${{ inputs.title }}/g" \
          -e "s/{{environment}}/${{ inputs.environment }}/g" \
          -e "s/{{deployment_url}}/${{ inputs.deployment_url }}/g" \
          -e "s/{{branch}}/${{ inputs.branch }}/g" \
          -e "s/{{location_code}}/${{ inputs.location_code }}/g" \
          -e "s/{{resource_group}}/${{ inputs.resource_group }}/g" \
          -e "s/{{color}}/${{ inputs.color }}/g" \
          -e "s/{{approval_url}}/${{ inputs.approval_url }}/g" \
          -e "s/{{rollback_url}}/${{ inputs.rollback_url }}/g")
        # Output the JSON payload for debugging
        echo "Generated Payload:" 
        echo "$PAYLOAD"
        echo "::set-output name=payload::$PAYLOAD"

    - name: Send Teams Notification
      shell: bash
      run: |
        echo "Sending notification to Teams using the following payload:"
        cat <<< "${{ steps.build_payload.outputs.payload }}"
        curl -X POST -H "Content-Type: application/json" -d "${{ steps.build_payload.outputs.payload }}" "${{ inputs.webhook_url }}"
