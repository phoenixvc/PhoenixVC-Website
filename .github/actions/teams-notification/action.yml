name: "Teams Notification (Hardcoded Test)"
description: "Hardcoded test to post directly to a Logic App endpoint."

runs:
  using: "composite"
  steps:
    - name: Hardcoded Payload for Testing
      shell: bash
      id: build_payload
      run: |
        # Hardcoded payload â€“ adjust values as needed
        PAYLOAD='{
          "teamsWebhookUrl": "https://test.com",
          "locationCode": "euw",
          "resourceGroup": "staging-euw-rg-phoenixvc-website",
          "environment": "staging",
          "branch": "refs/pull/25/merge",
          "message": "The deployment to the STAGING environment has completed successfully. Please review the deployment and take any necessary actions.",
          "title": "Staging Deployment Complete",
          "color": "0076D7",
          "deploymentUrl": "https://jolly-pebble-05d585a03.6.azurestaticapps.net",
          "approvalUrl": "https://test.com",
          "rollbackUrl": "",
          "encodedToken": "Z2hzX1FEOHlQRUt0bGN5TE44WkV0Y1ZqM0dhcEZUclFQYTN0ZXRtRwo=",
          "encodedTeamsToken": "Cg==",
          "adaptiveCard": {
            "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
            "type": "AdaptiveCard",
            "version": "1.2",
            "body": [
              {
                "type": "TextBlock",
                "text": "Phoenix VC staging Deployment Notification",
                "weight": "Bolder",
                "size": "Large"
              },
              {
                "type": "TextBlock",
                "text": "Deployment to staging Completed",
                "wrap": true
              },
              {
                "type": "FactSet",
                "facts": [
                  { "title": "Environment", "value": "staging" },
                  { "title": "Location", "value": "euw" },
                  { "title": "Resource Group", "value": "staging-euw-rg-phoenixvc-website" },
                  { "title": "Site URL", "value": "https://jolly-pebble-05d585a03.6.azurestaticapps.net" }
                ]
              },
              {
                "type": "TextBlock",
                "text": "The deployment to staging has completed successfully. Please review the details above and take any necessary actions.",
                "wrap": true
              }
            ],
            "actions": [
              {
                "type": "Action.OpenUrl",
                "title": "View Site",
                "url": "https://jolly-pebble-05d585a03.6.azurestaticapps.net"
              },
              {
                "type": "Action.OpenUrl",
                "title": "Approve Production Deployment",
                "url": "https://test.com"
              },
              {
                "type": "Action.OpenUrl",
                "title": "Rollback Deployment",
                "url": "https://test.com"
              }
            ]
          }
        }'
        echo "Generated Payload:"
        echo "$PAYLOAD"
        echo "payload<<EOF" >> $GITHUB_OUTPUT
        echo "$PAYLOAD" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Invoke Hardcoded Logic App Endpoint
      shell: bash
      run: |
        echo "Invoking Logic App via HTTP trigger..."
        # Compact the payload using jq
        COMPACT_PAYLOAD=$(jq -c . <<< '${{ steps.build_payload.outputs.payload }}')
        echo "Payload to be sent:"
        echo "$COMPACT_PAYLOAD"
        # Use a hardcoded, known-good Logic App endpoint URL
        LOGIC_APP_URL="https://prod-93.westeurope.logic.azure.com:443/workflows/807465debd7f4ce4a172b3bc56e5402f/triggers/manual/paths/invoke?api-version=2019-05-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=m645Lh0U8Ek1M9yBuugO-8dqQA5u-XVa8ZHOHjnwqB8"
        echo "Using Logic App URL: $LOGIC_APP_URL"
        RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST -H "Content-Type: application/json" \
          -d "$COMPACT_PAYLOAD" \
          "$LOGIC_APP_URL")
        echo "Response from Logic App:"
        echo "$RESPONSE"
