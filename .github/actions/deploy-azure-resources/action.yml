name: "Deploy Azure Resources"
description: "Deploys infrastructure resources for a given environment"
inputs:
  environment:
    description: "The deployment environment (staging or prod)"
    required: true
  azure_subscription_id:
    description: "Azure Subscription ID"
    required: true
  azure_credentials:
    description: "Azure credentials for authentication"
    required: true
  location_code:
    description: "Location code for resource naming"
    required: true
  repository:
    description: "GitHub repository to use"
    required: true
  token:
    description: "GitHub token"
    required: true
outputs:
  staticSiteUrl:
    description: "URL of the deployed Static Web App"
    value: ${{ steps.deploy.outputs.staticSiteUrl }}
  logicAppUrl:
    description: "URL of the deployed Logic App"
    value: ${{ steps.retrieve_logic_url.outputs.logicAppUrl }}
runs:
  using: "composite"
  steps:
    - name: Validate Azure Subscription ID
      shell: bash
      run: |
        if [[ -z "${{ inputs.azure_subscription_id }}" ]]; then
          echo "âŒ ERROR: AZURE_SUBSCRIPTION_ID is empty!"
          exit 1
        else
          echo "âœ… AZURE_SUBSCRIPTION_ID: ${{ inputs.azure_subscription_id }}"
        fi
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.repository }}
        token: ${{ inputs.token }}
        fetch-depth: 0

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ inputs.azure_credentials }}

    - name: Make deploy script executable
      run: chmod +x ./scripts/deployment/deploy.sh
      shell: bash

    - name: Run Resource Deployment Script
      shell: bash
      run: |
        ./scripts/deployment/deploy.sh --env ${{ inputs.environment }}
      env:
        ENVIRONMENT: ${{ inputs.environment }}
        RG_NAME: ${{ inputs.environment }}-${{ inputs.location_code }}-rg-phoenixvc-website
        SWA_NAME: ${{ inputs.environment }}-${{ inputs.location_code }}-swa-phoenixvc-website
        AZURE_SUBSCRIPTION_ID: ${{ inputs.azure_subscription_id }}

    - name: Retrieve Logic App Trigger URL
      id: retrieve_logic_url
      shell: bash
      run: |
        # Define Variables
        subscriptionId="${{ inputs.azure_subscription_id }}"
        resourceGroupName="${{ inputs.environment }}-${{ inputs.location_code }}-rg-phoenixvc-website"
        logicAppName="${{ inputs.environment }}-${{ inputs.location_code }}-la-phoenixvc"
        workflowName="manual"
        triggerName="manual"

        # Log Values
        echo "âœ… Subscription ID: $subscriptionId"
        echo "âœ… Resource Group: $resourceGroupName"
        echo "âœ… Logic App: $logicAppName"
        echo "âœ… Workflow Name: $workflowName"
        echo "âœ… Trigger Name: $triggerName"

        # Construct the REST API URL with a valid API version
        url="https://management.azure.com/subscriptions/$subscriptionId/resourceGroups/$resourceGroupName/providers/Microsoft.Logic/workflows/$logicAppName/triggers/$triggerName/listCallbackUrl?api-version=2019-05-01"

        echo "ðŸš€ API Call: $url"

        # Retrieve the callback URL using az rest
        response=$(az rest --method POST --uri "$url" --query "value" -o tsv)

        # Validate Response
        if [[ -n "$response" ]]; then
          echo "âœ… Retrieved Logic App URL"
          echo "logicAppUrl=$response" >> "$GITHUB_OUTPUT"
        else
          echo "âš ï¸ Logic App URL could not be retrieved"
          echo "logicAppUrl=" >> "$GITHUB_OUTPUT"
        fi
