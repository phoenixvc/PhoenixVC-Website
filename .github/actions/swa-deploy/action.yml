name: "SWA Deploy"
description: "Deploy site via SWA CLI with Azure CLI fallback from a downloaded artifact."
inputs:
  artifact-name:
    description: "The name of the artifact to download"
    required: true
  run-id:
    description: "The run ID from which to download the artifact"
    required: true
  app-name:
    description: "The SWA app name"
    required: true
  resource-group:
    description: "The resource group for the SWA app"
    required: true
  env:
    description: "The deployment environment (e.g. staging, prod)"
    required: true
  artifact-path:
    description: "Local path to download the artifact to"
    required: false
    default: "./build-artifact"
  azure_credentials:
    description: "Azure credentials for authentication"
    required: true
  deployment_token:
    description: "SWA deployment token (optional, will be retrieved from Azure if not provided)"
    required: false
  github_token:
    description: "GitHub token with permissions to access artifacts"
    required: true
outputs:
  deployment_url:
    description: "The URL of the deployed application"
    value: ${{ steps.get_deployment_url.outputs.url }}
  deployment_id:
    description: "Unique identifier for this deployment"
    value: ${{ steps.generate_deployment_id.outputs.id }}
runs:
  using: "composite"
  steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate Deployment ID
      id: generate_deployment_id
      shell: bash
      run: |
        DEPLOYMENT_ID="${{ github.run_id }}_${{ github.sha }}"
        echo "id=${DEPLOYMENT_ID}" >> $GITHUB_OUTPUT
        echo "Generated Deployment ID: ${DEPLOYMENT_ID}"

    - name: Debug Artifact Information
      shell: bash
      run: |
        echo "==========================="
        echo "ðŸ” DEBUG: Artifact Information"
        echo "==========================="
        echo "Artifact Name: ${{ inputs.artifact-name }}"
        echo "Run ID: ${{ inputs.run-id }}"
        echo "Repository: ${{ github.repository }}"
        echo "Current Run ID: ${{ github.run_id }}"
        echo "==========================="

    - name: List Available Artifacts
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      run: |
        echo "==========================="
        echo "ðŸ” DEBUG: Listing Available Artifacts"
        echo "==========================="
        RUN_ID="${{ inputs.run-id }}"

        echo "Checking artifacts for run ID: $RUN_ID"
        ARTIFACTS=$(curl -sSL -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts")

        echo "API Response:"
        echo "$ARTIFACTS" | jq -r '.'

        ARTIFACT_COUNT=$(echo "$ARTIFACTS" | jq -r '.total_count')
        echo "Total artifacts found: $ARTIFACT_COUNT"

        if [ "$ARTIFACT_COUNT" -gt 0 ]; then
          echo "Available artifacts:"
          echo "$ARTIFACTS" | jq -r '.artifacts[] | "- " + .name'
        else
          echo "No artifacts found for run ID: $RUN_ID"
        fi
        echo "==========================="

    - name: Download Artifact via GitHub API with Retries
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      run: |
        ARTIFACT_NAME="${{ inputs.artifact-name }}"
        RUN_ID="${{ inputs.run-id }}"
        OUTPUT_DIR="${{ inputs.artifact-path }}"
        MAX_RETRIES=5
        RETRY_DELAY=15
        ATTEMPT=1
        SUCCESS=false

        mkdir -p "$OUTPUT_DIR"

        while [[ $ATTEMPT -le $MAX_RETRIES && "$SUCCESS" != "true" ]]; do
          echo "Attempt $ATTEMPT of $MAX_RETRIES to download artifact..."
          echo "Retrieving artifact download URL for '$ARTIFACT_NAME' from run ID '$RUN_ID'..."

          ARTIFACTS_RESPONSE=$(curl -sSL -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts")

          # Check if the API call was successful
          if [[ $(echo "$ARTIFACTS_RESPONSE" | jq -r 'has("message")') == "true" ]]; then
            echo "âŒ GitHub API Error: $(echo "$ARTIFACTS_RESPONSE" | jq -r '.message')"
            echo "Full response:"
            echo "$ARTIFACTS_RESPONSE"
            echo "Retrying in $RETRY_DELAY seconds..."
            sleep $RETRY_DELAY
            ATTEMPT=$((ATTEMPT + 1))
            RETRY_DELAY=$((RETRY_DELAY + 5))
            continue
          fi

          # Extract the download URL for the specific artifact
          ARTIFACT_URL=$(echo "$ARTIFACTS_RESPONSE" | \
            jq -r ".artifacts[] | select(.name==\"$ARTIFACT_NAME\") | .archive_download_url")

          if [ -z "$ARTIFACT_URL" ] || [ "$ARTIFACT_URL" == "null" ]; then
            echo "âŒ Artifact '$ARTIFACT_NAME' not found for run ID '$RUN_ID'."
            echo "Available artifacts:"
            echo "$ARTIFACTS_RESPONSE" | jq -r '.artifacts[] | "- " + .name'

            # Try to use the most recent artifact with a similar name pattern if exact match not found
            echo "Attempting to find a similar artifact..."
            SIMILAR_ARTIFACT=$(echo "$ARTIFACTS_RESPONSE" | \
              jq -r ".artifacts[] | select(.name | startswith(\"web-dist\")) | .name" | head -1)

            if [ -n "$SIMILAR_ARTIFACT" ]; then
              echo "Found similar artifact: $SIMILAR_ARTIFACT"
              ARTIFACT_URL=$(echo "$ARTIFACTS_RESPONSE" | \
                jq -r ".artifacts[] | select(.name==\"$SIMILAR_ARTIFACT\") | .archive_download_url")
              echo "Using artifact: $SIMILAR_ARTIFACT instead"
            else
              echo "No similar artifacts found. Retrying in $RETRY_DELAY seconds..."
              sleep $RETRY_DELAY
              ATTEMPT=$((ATTEMPT + 1))
              RETRY_DELAY=$((RETRY_DELAY + 5))
              continue
            fi
          fi

          echo "Downloading artifact from URL: $ARTIFACT_URL"

          # Download with retry for the actual file download
          download_success=false
          download_attempts=0
          max_download_attempts=3

          while [[ $download_attempts -lt $max_download_attempts && "$download_success" != "true" ]]; do
            if curl -sSL -H "Authorization: Bearer $GITHUB_TOKEN" -L "$ARTIFACT_URL" --output artifact.zip; then
              download_success=true
            else
              download_attempts=$((download_attempts + 1))
              echo "Download attempt $download_attempts failed. Retrying..."
              sleep 5
            fi
          done

          if [[ "$download_success" != "true" ]]; then
            echo "âŒ Failed to download artifact after $max_download_attempts attempts"
            ATTEMPT=$((ATTEMPT + 1))
            continue
          fi

          echo "Extracting artifact to '$OUTPUT_DIR'..."
          if unzip -q artifact.zip -d "$OUTPUT_DIR"; then
            rm artifact.zip
            echo "âœ… Artifact downloaded and extracted successfully."
            echo "Contents of artifact directory:"
            ls -la "$OUTPUT_DIR"
            SUCCESS=true
          else
            echo "âŒ Failed to extract artifact"
            rm -f artifact.zip
            ATTEMPT=$((ATTEMPT + 1))
            continue
          fi
        done

        if [[ "$SUCCESS" != "true" ]]; then
          echo "âŒ Failed to download and extract artifact after $MAX_RETRIES attempts"
          exit 1
        fi

    # Login to Azure
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ inputs.azure_credentials }}

    # Ensure Azure CLI Logic Extension is Installed
    - name: Ensure Azure CLI Logic Extension is Installed
      shell: bash
      run: |
        if ! az extension show --name logic &>/dev/null; then
          az extension add --name logic --yes
        else
          echo "Azure CLI logic extension is already installed."
        fi

    # Ensure the config file is properly placed
    - name: Prepare configuration
      shell: bash
      run: |
        echo "Preparing configuration..."
        mkdir -p ${{ inputs.artifact-path }}/.config
        if [ ! -f "${{ inputs.artifact-path }}/.config/staticwebapp.config.json" ]; then
          echo "Copying staticwebapp.config.json to artifact directory..."
          cp .config/staticwebapp.config.json ${{ inputs.artifact-path }}/.config/
        else
          echo "Config file already exists in artifact directory"
        fi
        echo "Using configuration:"
        cat ${{ inputs.artifact-path }}/.config/staticwebapp.config.json

    # Always retrieve the deployment token dynamically from Azure
    - name: Get SWA Deployment Token
      id: get_token
      shell: bash
      run: |
        echo "==========================="
        echo "ðŸ” DEBUG: Retrieving SWA Deployment Token"
        echo "==========================="

        # Try multiple methods to get the deployment token

        # Method 1: Use az staticwebapp secrets list
        echo "Method 1: Using az staticwebapp secrets list..."
        set +e  # Don't exit on error
        TOKEN=$(az staticwebapp secrets list --name ${{ inputs.app-name }} --resource-group ${{ inputs.resource-group }} --query "properties.apiKey" -o tsv 2>&1)
        METHOD1_EXIT_CODE=$?
        set -e  # Resume exit on error

        if [[ $METHOD1_EXIT_CODE -eq 0 && -n "$TOKEN" && "$TOKEN" != "null" ]]; then
          echo "âœ… Successfully retrieved token using Method 1"
        echo "::add-mask::$TOKEN"
        echo "deployment_token=$TOKEN" >> $GITHUB_OUTPUT
          echo "==========================="
          exit 0
        else
          echo "âš ï¸ Method 1 failed: $TOKEN"
        fi

        # Method 2: Use az rest API call
        echo "Method 2: Using az rest API call..."
        SUBSCRIPTION_ID=$(az account show --query id -o tsv)
        API_VERSION="2019-12-01-preview"
        URL="https://management.azure.com/subscriptions/$SUBSCRIPTION_ID/resourceGroups/${{ inputs.resource-group }}/providers/Microsoft.Web/staticSites/${{ inputs.app-name }}/listSecrets?api-version=$API_VERSION"

        set +e  # Don't exit on error
        TOKEN=$(az rest --method post --uri "$URL" --query "properties.apiKey" -o tsv 2>&1)
        METHOD2_EXIT_CODE=$?
        set -e  # Resume exit on error

        if [[ $METHOD2_EXIT_CODE -eq 0 && -n "$TOKEN" && "$TOKEN" != "null" ]]; then
          echo "âœ… Successfully retrieved token using Method 2"
          echo "::add-mask::$TOKEN"
          echo "deployment_token=$TOKEN" >> $GITHUB_OUTPUT
          echo "==========================="
          exit 0
        else
          echo "âš ï¸ Method 2 failed: $TOKEN"
        fi

        # Method 3: Use az staticwebapp show and extract from response
        echo "Method 3: Using az staticwebapp show..."
        set +e  # Don't exit on error
        SITE_INFO=$(az staticwebapp show --name ${{ inputs.app-name }} --resource-group ${{ inputs.resource-group }} -o json)
        METHOD3_EXIT_CODE=$?
        set -e  # Resume exit on error

        if [[ $METHOD3_EXIT_CODE -eq 0 ]]; then
          echo "Got site info, attempting to retrieve token from site properties..."
          # Try to extract token from site info (this is a fallback and might not work)
          TOKEN=$(echo "$SITE_INFO" | jq -r '.properties.apiKey // empty')

          if [[ -n "$TOKEN" && "$TOKEN" != "null" ]]; then
            echo "âœ… Successfully retrieved token using Method 3"
            echo "::add-mask::$TOKEN"
            echo "deployment_token=$TOKEN" >> $GITHUB_OUTPUT
            echo "==========================="
            exit 0
          else
            echo "âš ï¸ Method 3 failed: Could not extract token from site info"
          fi
        else
          echo "âš ï¸ Method 3 failed: Could not get site info"
        fi

        # All methods failed, try to use the deployment token provided as input (if any)
        if [[ -n "${{ inputs.deployment_token }}" ]]; then
          echo "âœ… Using deployment token provided as input"
          echo "::add-mask::${{ inputs.deployment_token }}"
          echo "deployment_token=${{ inputs.deployment_token }}" >> $GITHUB_OUTPUT
          echo "==========================="
          exit 0
        fi

        # All methods failed
        echo "âŒ All methods to retrieve deployment token failed!"
        echo "==========================="
        exit 1

    # Debug step to validate token (without revealing it)
    - name: Validate Deployment Token
      shell: bash
      run: |
        echo "==========================="
        echo "ðŸ” DEBUG: Validating Deployment Token"
        echo "==========================="
        TOKEN="${{ steps.get_token.outputs.deployment_token }}"
        if [[ -z "$TOKEN" ]]; then
          echo "âŒ ERROR: Deployment token is empty!"
          exit 1
        else
          TOKEN_LENGTH=${#TOKEN}
          echo "âœ… Deployment token is set (length: $TOKEN_LENGTH characters)"
          echo "First 4 chars: ${TOKEN:0:4}..."
          echo "Last 4 chars: ...${TOKEN: -4}"
        fi
        echo "==========================="

    # Use the Azure/static-web-apps-deploy action with the dynamically retrieved token
    - name: Deploy to Azure Static Web Apps
      id: deploy
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ steps.get_token.outputs.deployment_token }}
        repo_token: ${{ inputs.github_token }}
        action: "upload"
        app_location: ${{ inputs.artifact-path }}
        api_location: ""
        output_location: ""
        config_file_location: ".config"
        skip_app_build: true
      env:
        DEPLOYMENT_PROVIDER: "DevOps"
        DEPLOYMENT_ID: ${{ steps.generate_deployment_id.outputs.id }}

    - name: Get Deployment URL
      id: get_deployment_url
      shell: bash
      run: |
        URL=$(az staticwebapp show --name ${{ inputs.app-name }} --resource-group ${{ inputs.resource-group }} --query "defaultHostname" -o tsv)
        if [[ -n "$URL" ]]; then
          FULL_URL="https://$URL"
          echo "url=$FULL_URL" >> $GITHUB_OUTPUT
          echo "Deployment URL: $FULL_URL"
        else
          echo "url=https://${{ inputs.app-name }}.azurestaticapps.net" >> $GITHUB_OUTPUT
          echo "Could not retrieve URL, using default format"
        fi
