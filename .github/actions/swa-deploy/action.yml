name: "SWA Deploy"
description: "Deploy site via SWA CLI with Azure CLI fallback from a downloaded artifact."
inputs:
  artifact-name:
    description: "The name of the artifact to download"
    required: true
  app-name:
    description: "The SWA app name"
    required: true
  resource-group:
    description: "The resource group for the SWA app"
    required: true
  env:
    description: "The deployment environment (e.g. staging, prod)"
    required: true
  artifact-path:
    description: "Local path to download the artifact to"
    required: false
    default: "./build-artifact"
  azure_credentials:
    description: "Azure credentials for authentication"
    required: true
  deployment_token:
    description: "SWA deployment token"
    required: true
outputs:
  deployment_url:
    description: "The URL of the deployed application"
    value: ${{ steps.get_deployment_url.outputs.url }}
runs:
  using: "composite"
  steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download Web App Artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact-name }}
        path: ${{ inputs.artifact-path }}

    # Login to Azure first - this will prevent the interactive login prompt
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ inputs.azure_credentials }}

    # Try direct Azure CLI deployment method first (most reliable in CI/CD)
    - name: Deploy using Azure CLI (Primary Method)
      id: az_cli_deploy
      shell: bash
      run: |
        echo "Installing Azure CLI extension for Static Web Apps..."
        az extension add --name staticwebapp --only-show-errors || echo "Extension already installed"
        
        echo "Deploying to ${{ inputs.env }} environment using Azure CLI..."
        az staticwebapp deploy \
          --name ${{ inputs.app-name }} \
          --resource-group ${{ inputs.resource-group }} \
          --source ${{ inputs.artifact-path }} \
          --env ${{ inputs.env }} \
          --token "${{ inputs.deployment_token }}" \
          --verbose || echo "az_cli_failed=true" >> $GITHUB_OUTPUT
      continue-on-error: true

    # Only try SWA CLI if Azure CLI fails
    - name: Setup Node.js (Fallback)
      if: ${{ steps.az_cli_deploy.outputs.az_cli_failed == 'true' }}
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Azure Static Web Apps CLI (Fallback)
      if: ${{ steps.az_cli_deploy.outputs.az_cli_failed == 'true' }}
      shell: bash
      run: |
        echo "Installing SWA CLI..."
        npm install --no-fund --no-audit --loglevel=error -g @azure/static-web-apps-cli

    - name: Deploy Site via SWA CLI (Fallback Method)
      if: ${{ steps.az_cli_deploy.outputs.az_cli_failed == 'true' }}
      shell: bash
      run: |
        echo "Deploying to ${{ inputs.env }} using SWA CLI from artifact..."
        # Add sleep to ensure file system is ready
        sleep 2
        # Use chmod to ensure executable permissions
        chmod -R 755 ${{ inputs.artifact-path }}
        
        # Set SWA_CLI_DEPLOYMENT_TOKEN environment variable explicitly
        # This is the recommended way to avoid authentication prompts
        export SWA_CLI_DEPLOYMENT_TOKEN="${{ inputs.deployment_token }}"
        
        # Try deployment with explicit token but without the unsupported --skip-deploy-wait flag
        swa deploy "${{ inputs.artifact-path }}" \
          --deployment-token "${{ inputs.deployment_token }}" \
          --env "${{ inputs.env }}" \
          --no-use-keychain
    
    # Get the deployment URL for output
    - name: Get Deployment URL
      id: get_deployment_url
      shell: bash
      run: |
        # Get the URL from Azure CLI
        URL=$(az staticwebapp show --name ${{ inputs.app-name }} --resource-group ${{ inputs.resource-group }} --query "defaultHostname" -o tsv)
        if [[ -n "$URL" ]]; then
          FULL_URL="https://$URL"
          echo "url=$FULL_URL" >> $GITHUB_OUTPUT
          echo "Deployment URL: $FULL_URL"
        else
          echo "url=https://${{ inputs.app-name }}.azurestaticapps.net" >> $GITHUB_OUTPUT
          echo "Could not retrieve URL, using default format"
        fi
