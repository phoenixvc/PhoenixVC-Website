# Service Principals Guide {: #service-principals-guide}
ðŸ“„ `/docs/deployment/service-principals.md`

**Version:** 0.2.0  
**Last Updated:** 2025-02-14

> **NOTE:** This guide covers best practices for creating, rotating, and managing Service Principals (SPNs) for automated deployments in Azure. It also references [ADR 001: Credential Rotation](/src/main/guides/deployment/adrs/adr-001-credential-rotation.md) for detailed rotation procedures.

---

## Overview {: #overview}
Service Principals (SPNs) are non-interactive Azure Active Directory identities used for authenticating applications and automating deployments. Proper management of SPNs is critical for ensuring secure, automated operations in your Azure environment.

---

## Creating a Service Principal {: #creating-a-service-principal}
To create a new SPN with minimal required permissions (typically the Contributor role):

```bash
az ad sp create-for-rbac \
  --name "phoenixvc-deployer" \
  --role contributor \
  --scopes "/subscriptions/<YOUR_SUBSCRIPTION_ID>" \
  --sdk-auth
```

- **Parameters:**
  - `--name`: Use a consistent naming convention (e.g., `phoenixvc-deployer` or `phoenixvc-<purpose>`).
  - `--role`: Assign the appropriate role. The Contributor role is common, but you may need to limit permissions further.
  - `--scopes`: Limit the scope to the necessary subscription or resource group.
  - `--sdk-auth`: Outputs a JSON object of credentials for integration with CI/CD pipelines (e.g., GitHub Actions).

---

## Best Practices for SPN Management {: #best-practices-for-spn-management}
### Naming Conventions {: #naming-conventions}
- Use a clear and descriptive name.  
  Example: `phoenixvc-deployer` for deployment purposes, or `phoenixvc-backup` for backup-related tasks.

### Principle of Least Privilege {: #principle-of-least-privilege}
- Grant only the permissions necessary for the SPNâ€™s function.
- Consider creating custom roles if built-in roles provide excessive permissions.

### Credential Rotation {: #credential-rotation}
- **Manual Rotation:**  
  Periodically rotate credentials using your established process. For manual rotation details, refer to [ADR 001: Credential Rotation](/src/main/guides/deployment/adrs/adr-001-credential-rotation.md).
- **Automated Rotation (Future Enhancement):**  
  Evaluate automation options to reduce human error and ensure regular updates.

### Storing SPN Credentials {: #storing-spn-credentials}
- **CI/CD Integration:**  
  Store the JSON output from the SPN creation as a secret in your CI/CD system (e.g., GitHub Secrets).
- **Azure Key Vault:**  
  Consider storing credentials in Azure Key Vault to secure them and control access.

---

## Verifying SPN Functionality {: #verifying-spn-functionality}
After creating an SPN, verify that it has the expected permissions:

```bash
# Check the SPN's role assignments {: #check-the-spns-role-assignments}
az role assignment list --assignee <SPN_APP_ID>

# Validate that the SPN can access necessary resources {: #validate-that-the-spn-can-access-necessary-resources}
az group show --name <RESOURCE_GROUP_NAME>
```

Replace `<SPN_APP_ID>` and `<RESOURCE_GROUP_NAME>` with the appropriate values.

---

## Troubleshooting Common SPN Issues {: #troubleshooting-common-spn-issues}
- **Insufficient Permissions:**  
  Verify the assigned role and scope using `az role assignment list`.
- **Authentication Failures:**  
  Ensure the credentials stored in your CI/CD environment match those generated by the SPN.
- **Credential Expiry:**  
  Monitor expiration dates and schedule rotations to avoid downtime.
- **Unexpected Behavior:**  
  Check audit logs and use Azure Monitor to trace SPN activity.

---

## Additional Resources {: #additional-resources}
- [Azure CLI Documentation](https://docs.microsoft.com/en-us/cli/azure/)
- [Azure Active Directory SPN Management](https://docs.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals)
- [ADR 001: Credential Rotation](/src/main/guides/deployment/adrs/adr-001-credential-rotation.md)

---

## TODO {: #todo}
- [ ] Expand with detailed rotation procedures once automated rotation is implemented.
- [ ] Include examples for SPN usage in specific deployment scenarios.
- [ ] Add a section on integrating SPN verification with monitoring tools.

---

## Revision History {: #revision-history}
| Version | Date       | Author       | Changes                                  |
|---------|------------|--------------|------------------------------------------|
| 0.2.0   | 2025-02-14 | HJ Smit      | Improved details, added verification & troubleshooting tips |
| 0.1.0   | 2025-02-14 | HJ Smit      | Initial draft                           |
